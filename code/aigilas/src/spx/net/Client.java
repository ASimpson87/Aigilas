package spx.net;import java.io.IOException;import java.net.Socket;import java.util.HashMap;import spx.core.RNG;import spx.core.Settings;import spx.devtools.DevConsole;import xna.wrapper.Console;public class Client {	private static Client __instance;	public static Client Get() {		if (__instance == null) {			__instance = new Client();			while (!__instance.IsConnected()) {				if (Settings.Get().GetClientVerbose()) {					System.out.println("CLIENT: Waiting for connection");				}				__instance.Update();			}		}		return __instance;	}	// Client<->Server	private Socket _server;	private int _serverTimeout = 1000;	private MessageContents _message;	private MessageContents _outMessage;	private MessageContents _contents = MessageContents.Empty();	private Communicator _comm;	private int _heartBeat = 30;	// Client<->Game	private Integer _initialPlayerIndex;	private boolean _isGameStarting;	private boolean _dungeonHasLoaded = false;	private boolean _isConnected;	private final HashMap<Integer, HashMap<Integer, Boolean>> _playerStatus = new HashMap<>();	private Client() {		if (Settings.Get().GetClientVerbose()) {			System.out.println("CLIENT: Attempting to make a new connection");		}		_server = null;		for (int ii = 0; ii < MessageContents.PlayerMax; ii++) {			_playerStatus.put(ii, new HashMap<Integer, Boolean>());			for (int jj = 0; jj < MessageContents.CommandMax; jj++) {				_playerStatus.get(ii).put(jj, false);			}		}		try {			_server = new Socket(Settings.Get().GetIp(), Settings.Get().GetPort());			// _server.setSoTimeout(_serverTimeout);			_outMessage = MessageContents.CreateInit(0, 0);			_comm = new Communicator(_server);			SendMessage(_outMessage);			AwaitReply(MessageTypes.CONNECT);			_server.close();		}		catch (Exception e) {			e.printStackTrace();		}	}	// Client<->Game communication	public boolean IsGameStarting() {		return _isGameStarting;	}	public boolean IsConnected() {		return _isConnected;	}	public void HeartBeat() {		if (!_dungeonHasLoaded) {			_heartBeat--;			if (_heartBeat <= 0) {				Console.WriteLine("CLIENT: Heartbeating...");				SendMessage(MessageContents.CreateHeartBeat());				_heartBeat = 15;			}		}	}	public void DungeonHasLoaded() {		Console.WriteLine("CLIENT: Dungeon has finished loading...");		_dungeonHasLoaded = true;	}	public boolean NextTurn() {		_contents.Clear();		Update();		if (_contents.MessageType == MessageTypes.SYNC_STATE) {			if (Settings.Get().GetClientVerbose()) {				DevConsole.Get().Add("RNG Test Broke?: " + RNG.Next(0, 100000));			}			if (Settings.Get().GetClientVerbose()) {				DevConsole.Get().Add("CLIENT: Synced  extends  " + _contents.TurnCount + ". Seeding extends  " + _contents.RngSeed);			}			RNG.Seed(_contents.RngSeed);			if (Settings.Get().GetClientVerbose()) {				DevConsole.Get().Add("RNG Test extends  " + RNG.Next(0, 100000) + " extends  Turn - " + _contents.TurnCount);			}			_heartBeat = 15;		}		return _contents.MessageType == MessageTypes.SYNC_STATE;	}	private void InitPlayer(int playerIndex, int command) {		if (!_playerStatus.containsKey(playerIndex)) {			_playerStatus.put(playerIndex, new HashMap<Integer, Boolean>());		}		if (!_playerStatus.get(playerIndex).containsKey(command)) {			_playerStatus.get(playerIndex).put(command, false);		}	}	public int GetFirstPlayerIndex() {		return _initialPlayerIndex;	}	// Client<->Server communication	public boolean IsActive(int command, int playerIndex) {		if (_playerStatus.containsKey(playerIndex) && _playerStatus.get(playerIndex).containsKey(command)) {			return _playerStatus.get(playerIndex).get(command);		}		return false;	}	public void SetState(int command, int playerIndex, boolean isActive) {		InitPlayer(playerIndex, command);		if (_playerStatus.get(playerIndex).get(command) != isActive) {			if (Settings.Get().GetClientVerbose()) {				Console.WriteLine("CLIENT: Moves extends  CMD({0}) PI({1}) AC({2})", command, playerIndex, isActive);			}			SendMessage(MessageContents.CreateMovement(command, playerIndex, isActive));		}	}	int _playerCount = 0;	public int GetPlayerCount() {		if (_playerCount == 0) {			SendMessage(MessageContents.CreatePlayerCount(0));			AwaitReply(MessageTypes.PLAYER_COUNT);			_playerCount = _contents.PlayerCount;		}		return _playerCount;	}	public void StartGame() {		SendMessage(MessageContents.Create(MessageTypes.START_GAME));	}	private void SendMessage(MessageContents contents) {		if (Settings.Get().GetClientVerbose()) {			System.out.println("CLIENT: Sending message -> " + contents.MessageType);		}		_comm.send(contents);	}	// If the server doesn't reply at some point with the messageType you expect	// Then the client will hang extends an infinite loop.	private void AwaitReply(MessageTypes messageType) {		if (Settings.Get().GetClientVerbose()) {			Console.WriteLine("CLIENT: Waiting for " + messageType);		}		try {			_server = new Socket(Settings.Get().GetIp(), Settings.Get().GetPort());			_comm = new Communicator(_server);			_message = _comm.receive();			if (_message != null) {				if (Settings.Get().GetClientVerbose()) {					Console.WriteLine("CLIENT: Waiting");				}				if (_contents.MessageType == messageType) {					if (Settings.Get().GetClientVerbose()) {						Console.WriteLine("CLIENT: Right message received");					}					return;				}				else {					if (Settings.Get().GetClientVerbose()) {						Console.WriteLine("CLIENT: Wrong message received extends  " + _contents.MessageType + " Expected extends  " + messageType);					}					HandleResponse(_contents);				}			}			_server.close();		}		catch (Exception e) {			e.printStackTrace();		}	}	public void Update() {		try {			if (Settings.Get().GetClientVerbose()) {				System.out.println("CLIENT: Updating");			}			_server = new Socket(Settings.Get().GetIp(), Settings.Get().GetPort());			_comm = new Communicator(_server);			_contents = _comm.receive();			if (_contents != null) {				HandleResponse(_contents);			}			_server.close();		}		catch (Exception hide) {			hide.printStackTrace();		}	}	private void HandleResponse(MessageContents contents) {		switch (contents.MessageType) {			case CONNECT:				if (Settings.Get().GetClientVerbose()) {					Console.WriteLine("CLIENT: Handshake successful. Starting player id extends  " + contents.PlayerIndex);				}				RNG.Seed(contents.RngSeed);				_initialPlayerIndex = (int) contents.PlayerCount;				_isConnected = true;				break;			case START_GAME:				Console.WriteLine("CLIENT: Start game reply has been received");				_isGameStarting = true;				break;			case SYNC_STATE:				if (Settings.Get().GetClientVerbose()) {					Console.WriteLine("CLIENT: Input state received");				}				contents.ReadPlayerState(_playerStatus);				break;			default:				if (Settings.Get().GetClientVerbose()) {					System.out.println("CLIENT: Unknown message type received -> " + _outMessage.MessageType);				}				break;		}	}	public void PrepareForNextTurn() {		SendMessage(MessageContents.CreateReadyForNextTurn());	}	public void Close() {		try {			_server.close();		}		catch (IOException e) {			e.printStackTrace();		}		System.out.println("CLIENT: Shutting down");	}}